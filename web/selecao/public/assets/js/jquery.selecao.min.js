$(function() {
    $.validator.addMethod("nome", function(value, element) {
        value = jQuery.trim(value);
        let valueSplit = value.split(" ");

        return valueSplit.length > 1;
    }, "Você precisa informar o seu nome completo.");

    $.validator.addMethod("maiorIdade", function(value, element) {
        value = value.split("/");
        let year = (new Date()).getFullYear();
        return (new Date().getFullYear() - value[2]) >= 18
    }, "É necessário ser maior de idade.");

    $.validator.addMethod("cpf", function(value, element) {

        value = jQuery.trim(value);
        value = value.replace(/[^0-9]/g, "");
        cpf = value;

        while (cpf.length < 11) cpf = "0" + cpf;
        var expReg = /^0+$|^1+$|^2+$|^3+$|^4+$|^5+$|^6+$|^7+$|^8+$|^9+$/;
        var a = [];
        var b = new Number;
        var c = 11;
        for (i = 0; i < 11; i++) {
            a[i] = cpf.charAt(i);
            if (i < 9) b += (a[i] * --c);
        }
        if ((x = b % 11) < 2) {
            a[9] = 0
        } else {
            a[9] = 11 - x
        }
        b = 0;
        c = 11;
        for (y = 0; y < 10; y++) b += (a[y] * c--);
        if ((x = b % 11) < 2) {
            a[10] = 0;
        } else {
            a[10] = 11 - x;
        }

        var retorno = true;
        if ((cpf.charAt(9) != a[9]) || (cpf.charAt(10) != a[10]) || cpf.match(expReg)) retorno = false;

        return this.optional(element) || retorno;

    }, "Informe um CPF válido");

    $.validator.addMethod("nis", function(value, element) {
        if ($.isNumeric(value) && value.replace(/_/g, "").length == 11)
            return true;
        return false;
    }, "Informe um CPF válido");

    $.fn.showMessage = function(options) {

        var $elp = $(this).length > 0 ? $(this) : null;
        var $title = options && options.title ? options.title : "";
        var $message = options && options.message ? options.message : "";
        var $type = options && options.type ? options.type : "default";

        var $elc = $("<div/>")
            .attr("class", "notice notice-" + $type)
            .append("<strong>" + $title + "</strong> " + $message);

        $('html,body').animate({
                scrollTop: $elc.offset().top - 200
            },
            'slow');

        return $elc.prependTo($elp);

    }

    $.fn.hideMessage = function(options) {

        $(this).find(".notice").remove();

    }

    /***
     * Ao selecionar uma opção inicial da seleção, carrega a
     * página requisitada no load após o efeito slide.
     *  
     */
    $(".selecao-form input[name='acao']").click(function() {
        if ($('input[name="acao"]:checked').val() != 'nvInscricao') {
            $(".acordo_edital").hide();
        } else {
            $(".acordo_edital").show();
        }
    });
    
    var el = ['<li class="list-group-item">',
             '	<div class="checkbox">	  ',
	         '		<label for="rdInscricao">',
	         '			<input type="radio" name="acao" id="rdInscricao" value="nvInscricao" required />',
             '              Realizar uma nova inscrição', 
             '		</label>',
             '	</div>',
             '</li>'];

    $(".selecao-form select[name='selecao']").change(function(e) {
        var select = $(e.target.options[e.target.selectedIndex]);

        if (select.data('urlEdital') && select.data('urlEdital').length >= 1) {
            $(".btn-edital a").attr('href', select.data('urlEdital')).removeClass('hidden').show();
        } else {
            $(".btn-edital a").attr('href', '').addClass('hidden').hide();
        }
        console.log(select.data('valid'));
        if(JSON.parse(select.data('valid'))){
        	if($("#rdInscricao").length == 0){
        		$(".action-list").prepend($(el.join("")));
        	}
        } else {
        	$("#rdInscricao").closest('.list-group-item').remove();
        }
        
        if (select.data('dtinicial') && select.data('dtinicial').length >= 1 && select.data('dtfinal') && select.data('dtfinal').length >= 1) {
            $(".dt-inicial").text(select.data('dtinicial'));
            $(".dt-final").text(select.data('dtfinal'));
            $(".periodo-inscricao").removeClass('hidden').show();
        } else {
            $(".periodo-inscricao").addClass('hidden').hide();
        }
    });

    $(".selecao-form select[name='vagas']").change(function(e) {
        var parent = $(".desc-funcao").parent();
        var select = $(e.target.options[e.target.selectedIndex]);

        if (!select.data('desc'))
            parent.addClass('hidden');
        else
            parent.removeClass('hidden');

        if (select.data('localidade') == 1) {
            $("#cbLocalidade").parent().removeClass('hidden');
        } else {
            $("#cbLocalidade option:eq(0)").prop('selected', true);
            $("#cbLocalidade").parent().addClass('hidden');
        }

        $(".desc-funcao").text(select.data('desc'));
    });

    $(".selecao-form").validate({
        rules: {
            edital: {
                required: function() {
                    if ($('input[name="acao"]:checked').val() != 'nvInscricao') {
                        return false;
                    } else {
                        return true;
                    }
                }
            }
        },
        messages: {
            selecao: "<span class=\"text-danger\">Escolha a seleção que deseja participar.</span>",
            acao: "<span class=\"text-danger\">Selecione o que deseja fazer.</span>",
            edital: "<span class=\"text-danger\">Você não leu e/ou não concordou com edital proposto para a seleção.</span>",
        },
        errorPlacement: function(error, element) {
            if (element.parent().parent().parent().parent(".list-group").length) {
                error.insertAfter(element.parent().parent().parent().parent().parent());
            } else if (element.parent().parent().parent(".acordo_edital").length) {
                error.insertAfter(element.parent().parent().parent());
            } else {
                error.insertAfter(element);
            }
        },
        submitHandler: function() {

            $(".loading").fadeIn('fast', function() {
                $("body").css({
                    overflow: 'hidden'
                });
            });

            var $sf = $(".selecao-form");
            var $lf = $(".load-form");
            var $r = $("input[name=acao]:checked").val();

            if ($r === 'nvInscricao')
                $lf.load('./recursos/formulario_inscricao.jsp?cdEvento=' + $("select[name='selecao']").val());
            else if ($r === 'grBoletoComprovante')
                $lf.load('./recursos/verificar_boleto_comprovante.jsp?cdEvento=' + $("select[name='selecao']").val());
            else if ($r === 'stInscricao')
                $lf.load('./recursos/verificar_situacao_inscricao.jsp?cdEvento=' + $("select[name='selecao']").val());
            else
                return false;

            $sf.hide("slide", {
                direction: "left"
            }, 'fast', function() {
                $lf.removeClass('hide').show("slide", {
                    direction: "left"
                }, 'fast');

                $(".loading").fadeOut('fast', function() {
                    $("body").css({
                        overflow: 'auto'
                    });
                });
            });
        }

    });

    $(".btn-back").click(function(e) {

        var $sf = $(".selecao-form");
        var $lf = $(".load-form");

        $lf.hide("slide", {
            direction: "left"
        }, 'fast', function() {
            $sf.removeClass('hide').show("slide", {
                direction: "left"
            }, 'fast');
        });

    });

    if ($("#stInscricaoBoletoForm, #stInscricaoForm").length > 0) {
        $("#stInscricaoForm, #stInscricaoBoletoForm").validate({
            rules: {
                nr_cpf: {
                    required: true,
                    cpf: true
                }
            },
            messages: {
                nr_cpf: {
                    required: "<span class=\"text-danger\">Informe o número de CPF.</span>",
                    cpf: "<span class=\"text-danger\">Informe um número de CPF válido.</span>"
                },
            },
            submitHandler: function(form) {

                $(".error").remove();

                $(".loading").fadeIn('fast', function() {
                    $("body").css({
                        overflow: 'hidden'
                    });
                });

                if (grecaptcha.getResponse(widgetId) === '') {
                    var error = $("<p class=\"text-danger text-center error\" style=\"font-size: 12px;font-weight:bold;\">Resolva o reconhecimento acima.</span>");
                    error.insertAfter($("#recaptcha"));
                    return false;
                }

                if ($(form).attr('id') === 'stInscricaoBoletoForm') {
                    $(".load-form").load("./recursos/emitir_boleto.jsp?cd_evento_principal=" + $("input[name='cd_evento_principal']").val() + "&nr_cpf=" + $("input[name='nr_cpf']").val(), function() {
                        $(".loading").fadeOut('fast', function() {
                            $("body").css({
                                overflow: 'auto'
                            });
                        });
                    });
                } else if ($(form).attr('id') === 'stInscricaoForm') {
                    $(".load-form").load("./recursos/situacao_inscricao.jsp?cd_evento_principal=" + $("input[name='cd_evento_principal']").val() + "&nr_cpf=" + $("input[name='nr_cpf']").val(), function() {
                        $(".loading").fadeOut('fast', function() {
                            $("body").css({
                                overflow: 'auto'
                            });
                        });
                    });
                } else {
                    return false;
                }
            }
        });
    }

    if ($("#nvInscricaoForm").length > 0) {

        $("input[name='isencao']").click(function() {
            if ($(this).val() == 1) {
                $("input[name='nr_isencao']").removeClass("hide").show().attr("disabled", false);
            } else {
                $("input[name='nr_isencao']").addClass("hide").hide().attr("disabled", true);
            }
        });

        $("input[name='dt_nascimento']").focusout(function() {
            var field = $(this).val().replace(/[^0-9]+/gi, " ").replace(/ +/g, '').trim();
            if (field.length < 8) {
                $(this).val("");
            }
        });

        $("input[name='nr_telefone']").focusout(function() {
            var field = $(this).val().replace(/[^0-9]+/gi, " ").replace(/ +/g, '').trim();
            if (field.length < 10) {
                $(this).val("");
            }
        });

        $("input[name='nr_isencao']").focusout(function() {
            var field = $(this).val().replace(/[^0-9]+/gi, " ").replace(/ +/g, '').trim();
            if (field.length < 11) {
                $(this).val("");
            }
        });

        $("input[name='nr_celular']").focusout(function() {
            var field = $(this).val().replace(/[^0-9]+/gi, " ").replace(/ +/g, '').trim();
            if (field.length < 11) {
                $(this).val("");
            }
        });

        $("input[name='nome']").keyup(function() {
            $(this).val($(this).val().replace(/  +/g, ' ').replace(/\d+/g, ''));
        }).change(function() {
            $(this).val($(this).val().trim());
        });
        
        
        $('[name="deficiencia"]').change(function(){        	
        	var len = [].slice.call(document.querySelectorAll("[name='deficiencia']")).filter(function(e) { 
        		return e.checked; 
    		}).length;
        	        	
        	if(len > 0){
        		$("[name='txtDeficienciaObservacao']").parent().removeClass('hidden');
        	} else {
        		$("[name='txtDeficienciaObservacao']").val("");
        		$("[name='txtDeficienciaObservacao']").parent().addClass('hidden');
        	}
        });

        $("input[name='nr_cep']").focusout(function() {
            var $cep = $(this).val();
            $.get('https://viacep.com.br/ws/' + $cep + '/json', function(response) {
                window.nmCidadeWS = response.localidade;
                $("input[name='logradouro']").val(response.logradouro.toUpperCase());
                $("input[name='bairro']").val(response.bairro.toUpperCase());
                $("select[name='estados'] option").filter(function() {
                    return this.text == response.uf.toUpperCase()
                }).attr('selected', true);
                $("select[name='estados']").trigger('change');
            });
        });
        
        $("#nvInscricaoForm").validate({
            rules: {
                nome: {
                    required: true,
                    nome: true
                },
                nr_cpf: {
                    required: true,
                    cpf: true
                },
                dt_nascimento: {
                    required: true,
                    maiorIdade: true
                },
                nr_isencao: {
                    required: function(element) {
                        if ($('input[name="isencao"]:checked').val() == 0) {
                            return false;
                        } else {
                            return true;
                        }
                    },
                    minlength: 11
                },
                localidade: {
                    required: function(element) {
                        if ($('select[name="localidade"]').val() > 0) {
                            return false;
                        } else {
                            return true;
                        }
                    }
                },
                nr_telefone: {
                    minlength: 10,
                    required: true,
                },
                nr_celular: {
                    minlength: 11,
                    required: true,
                },
                email: {
                    required: true,
                    email: true,
                }
            },
            onfocusout: function(element, event) {
                if (element.tagName === "TEXTAREA" || (element.tagName === "INPUT" && element.type !== "password")) {
                    element.value = $.trim(element.value);
                }
                if (!this.checkable(element) && (element.name in this.submitted || !this.optional(element))) {
                    this.element(element);
                }
            },
            messages: {
                nome: "<span class=\"text-danger\">Informe o seu nome completo.</span>",
                nr_rg: "<span class=\"text-danger\">Informe seu documento de identidade.</span>",
                orgao: "<span class=\"text-danger\">Informe o Orgão Expedidor de sua identidade.</span>",
                unfederativa: "<span class=\"text-danger\">Informe estado de emissão da sua identidade.</span>",
                nr_cpf: {
                    required: "<span class=\"text-danger\">Informe o número de CPF.</span>",
                    cpf: "<span class=\"text-danger\">Informe um número de CPF válido.</span>"
                },
                sexo: "<span class=\"text-danger\">Informe seu sexo.</span>",
                dt_nascimento: {
                    required: "<span class=\"text-danger\">Informe sua data de nascimento.</span>"
                },
                logradouro: "<span class=\"text-danger\">Informe seu endereço.</span>",
                bairro: "<span class=\"text-danger\">Informe seu bairro.</span>",
                nr_cep: "<span class=\"text-danger\">Informe seu cep.</span>",
                estados: "<span class=\"text-danger\">Informe o estado.</span>",
                cidades: "<span class=\"text-danger\">Informe a cidade.</span>",
                nr_endereco: "<span class=\"text-danger\">Informe o número do endereço.</span>",
                vagas: "<span class=\"text-danger\">Selecione o tipo de vaga a concorrer.</span>",
                localidade: "<span class=\"text-danger\">A vaga selecionada requer a escolha de um local de trabalho.</span>",
                nr_isencao: {
                    minlength: "<span class=\"text-danger\">Informe seu NIS.</span>",
                    required: "<span class=\"text-danger\">O NIS deve conter 11 dígitos.</span>"
                },
                nr_telefone: {
                    minlength: "<span class=\"text-danger\">Informe um telefone válido.</span>",
                    required: "<span class=\"text-danger\">Informe um telefone.</span>"
                },
                nr_celular: {
                    minlength: "<span class=\"text-danger\">Informe um celular válido.</span>",
                    required: "<span class=\"text-danger\">Informe um celular.</span>"
                },
                email: {
                    required: "<span class=\"text-danger\">Informe um e-mail.</span>",
                    email: "<span class=\"text-danger\">Informe um endereço de e-mail válido.</span>",
                }
            },
            submitHandler: function(form) {

                $("body").css('overflow', 'hidden');
                
                let def = [];
                $('#confirmacaoModel [data-ref]').each(function() {
                    let dataRef = $(this).data('ref');
                    let element = $("[name='" + dataRef + "']");

                    if (element.is('input'))
                        $(this).text(element.val() ? element.val() : "Não informado");

                    if (element.is("input[type='checkbox']"))
                        $(this).text(element.is(':checked') ? "Sim" : "Não");

                    if (element.is('select'))
                        $(this).text($("option:selected", element).text());
                    
                    if (element.is("input[type='checkbox']") && element.attr('data-label')){
                    	$("[data-label]").each(function(){
                    		if($(this).is(':checked')){
                        		def.push($(this).data('label'));                   			
                    		}
                    	});

                    	$(this).text(def.join(", ")); 
                    }        
                });

                var modal = $('#confirmacaoModel').off().modal({
                    backdrop: 'static',
                    keyboard: false
                }).on('click', '.btn-confirm', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    $(".loading").fadeIn('fast', function() {
                        $("body").css({
                            overflow: 'hidden'
                        });
                    });


                    let btn = $(this);

                    btn.attr('disabled', true);
                    modal.modal('toggle');

                    $(".error").remove();
                    $(form).hideMessage();
                    if (grecaptcha.getResponse(widgetId) === '') {
                        var error = $("<p class=\"text-danger text-center error\" style=\"font-size: 12px;font-weight:bold;\">Resolva o reconhecimento acima.</span>");
                        error.insertAfter($("#recaptcha"));
                        return false;
                    }

                    $.post('../request/selecao/', $(form).serialize(), function(response) {

                        btn.attr('disabled', false);

                        $(".loading").fadeOut('fast', function() {
                            $("body").css({
                                overflow: 'auto'
                            });
                        });

                        response = JSON.parse(response);

                        if (response.code >= 1) {
                            $(".load-form").load("./recursos/emitir_boleto.jsp?cd_evento_principal=" + $("input[name='cdEventoPrincipal']").val() + "&nr_cpf=" + $("input[name='nr_cpf']").val() + "&lg_ultima_inscricao=1");
                        } else {
                            $(form).showMessage({
                                title: "Atenção!",
                                message: response.message,
                                type: "danger"
                            });

                            $("#wrapper").animate({
                                scrollTop: 0
                            }, 300);
                        }
                        
                    });                    
                }).on('hidden.bs.modal', function(e) {
                    $("body").css('overflow', 'auto');
                });
            }
        });
    }

    $('.collapse').on('show.bs.collapse', function() {
        $otherPanels = $(this).parents('.panel-group').siblings('.panel-group');
        $('.collapse', $otherPanels).removeClass('in');
    });
	
});

$(window).load(function() {
    $(".loading").fadeOut('fast', function() {
        $("body").css({
            overflow: 'auto'
        });
    });
});