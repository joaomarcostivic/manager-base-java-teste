<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Bootswatch: Paper</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <link rel="stylesheet" href="https://bootswatch.com/paper/bootstrap.min.css">
        <link rel="stylesheet" href="./src/bootstrap.dialog.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="../bower_components/html5shiv/dist/html5shiv.js"></script>
        <script src="../bower_components/respond/dest/respond.min.js"></script>
        <![endif]-->
    </head>
	<style>
		html,body{height:100%;}
		body {background: url(background.jpg) right; background-size:cover;}
		.container { height:100%; }	
		#v {
			width:320px;
			height:240px;
		}		
		#qr-canvas{
			display:none;
		}
	</style>
    <body onload="load()">
        <div class="navbar navbar-default navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <a href="../" class="navbar-brand">Leitor QRCode</a>
                    <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    </button>
                </div>
                <div class="navbar-collapse collapse" id="navbar-main">
                    <ul class="nav navbar-nav">
                    </ul>
                </div>
            </div>
        </div>
        <div class="container" style="margin-top:64px;">
			<br />
            <div id="page-content" id="banner">
				<canvas id="qr-canvas"></canvas>				
				<div id="outdiv" class="center-block img-thumbnail"></div>
				<hr>
				<div class="well">
					<button id="btnEntrada" class="btn btn-block btn-lg btn-success" data-nrinscricao="" onClick="btnEntradaOnClick(this);" disabled>REGISTRAR ENTRADA</button>
					<button id="btnSaida" class="btn btn-block btn-lg btn-danger" data-nrinscricao="" onClick="btnSaidaOnClick(this);" disabled>REGISTRAR SAÍDA</button>
				</div>
            </div>
            <footer>
            </footer>
        </div>
        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>		
		<script type="text/javascript" src="./src/bootstrap.dialog.js"></script>
		<script type="text/javascript" src="./src/grid.js"></script>
		<script type="text/javascript" src="./src/version.js"></script>
		<script type="text/javascript" src="./src/detector.js"></script>
		<script type="text/javascript" src="./src/formatinf.js"></script>
		<script type="text/javascript" src="./src/errorlevel.js"></script>
		<script type="text/javascript" src="./src/bitmat.js"></script>
		<script type="text/javascript" src="./src/datablock.js"></script>
		<script type="text/javascript" src="./src/bmparser.js"></script>
		<script type="text/javascript" src="./src/datamask.js"></script>
		<script type="text/javascript" src="./src/rsdecoder.js"></script>
		<script type="text/javascript" src="./src/gf256poly.js"></script>
		<script type="text/javascript" src="./src/gf256.js"></script>
		<script type="text/javascript" src="./src/decoder.js"></script>
		<script type="text/javascript" src="./src/qrcode.js"></script>
		<script type="text/javascript" src="./src/findpat.js"></script>
		<script type="text/javascript" src="./src/alignpat.js"></script>
		<script type="text/javascript" src="./src/databr.js"></script>
        <script type="text/javascript">
		
		// QRCODE reader Copyright 2011 Lazar Laszlo
		// http://www.webqr.com

		var gCtx = null;
		var gCanvas = null;
		var c=0;
		var stype=0;
		var gUM=false;
		var webkit=false;
		var moz=false;
		var v=null;

		var imghtml='<div id="qrfile"><canvas id="out-canvas" width="320" height="240"></canvas>'+
			'<div id="imghelp">drag and drop a QRCode here'+
			'<br>or select a file'+
			'<input type="file" onchange="handleFiles(this.files)"/>'+
			'</div>'+
		'</div>';

		var vidhtml = '<video id="v" autoplay></video>';

		function dragenter(e) {
		  e.stopPropagation();
		  e.preventDefault();
		}

		function dragover(e) {
		  e.stopPropagation();
		  e.preventDefault();
		}
		function drop(e) {
		  e.stopPropagation();
		  e.preventDefault();

		  var dt = e.dataTransfer;
		  var files = dt.files;
		  if(files.length>0)
		  {
			handleFiles(files);
		  }
		  else
		  if(dt.getData('URL'))
		  {
			qrcode.decode(dt.getData('URL'));
		  }
		}

		function handleFiles(f)
		{
			var o=[];
			
			for(var i =0;i<f.length;i++)
			{
				var reader = new FileReader();
				reader.onload = (function(theFile) {
				return function(e) {
					gCtx.clearRect(0, 0, gCanvas.width, gCanvas.height);

					qrcode.decode(e.target.result);
				};
				})(f[i]);
				reader.readAsDataURL(f[i]);	
			}
		}

		function initCanvas(w,h)
		{
			gCanvas = document.getElementById("qr-canvas");
			gCanvas.style.width = w + "px";
			gCanvas.style.height = h + "px";
			gCanvas.width = w;
			gCanvas.height = h;
			gCtx = gCanvas.getContext("2d");
			gCtx.clearRect(0, 0, w, h);
		}


		function captureToCanvas() {
			if(stype!=1)
				return;
			if(gUM)
			{
				try{
					gCtx.drawImage(v,0,0);
					try{
						qrcode.decode();
					}
					catch(e){       
						console.log(e);
						setTimeout(captureToCanvas, 50);
					};
				}
				catch(e){       
						console.log(e);
						setTimeout(captureToCanvas, 50);
				};
			}
		}

		function htmlEntities(str) {
			return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
		}

		function read(a)
		{
			var html="<br>";
			if(a.indexOf("http://") === 0 || a.indexOf("https://") === 0)
				html+="<a target='_blank' href='"+a+"'>"+a+"</a><br>";
			html+="<b>"+htmlEntities(a)+"</b><br><br>";
			document.getElementById('btnEntrada').dataset.nrmatricula = htmlEntities(a);
			document.getElementById("btnEntrada").disabled = false;
			document.getElementById("btnSaida").disabled = false;
		}	

		function isCanvasSupported(){
		  var elem = document.createElement('canvas');
		  return !!(elem.getContext && elem.getContext('2d'));
		}
		function success(stream) {
			v.src = window.URL.createObjectURL(stream);
			gUM=true;
			setTimeout(captureToCanvas, 50);
		}
				
		function error(error) {
			gUM=false;
			return;
		}

		function load()
		{
			if(isCanvasSupported() && window.File && window.FileReader)
			{
				initCanvas(800, 600);
				qrcode.callback = read;
				document.getElementById("page-content").style.display="inline";
				setwebcam();
			}
			else
			{
				document.getElementById("page-content").style.display="inline";
				document.getElementById("page-content").innerHTML='<p id="mp1">QR code scanner for HTML5 capable browsers</p><br>'+
				'<br><p id="mp2">sorry your browser is not supported</p><br><br>'+
				'<p id="mp1">try <a href="http://www.mozilla.com/firefox"><img src="firefox.png"/></a> or <a href="http://chrome.google.com"><img src="chrome_logo.gif"/></a> or <a href="http://www.opera.com"><img src="Opera-logo.png"/></a></p>';
			}
		}

		function setwebcam()
		{
			if(stype==1)
			{
				setTimeout(captureToCanvas, 50);    
				return;
			}
			var n=navigator;
			document.getElementById("outdiv").innerHTML = vidhtml;
			v=document.getElementById("v");

			if(n.getUserMedia)
				n.getUserMedia({video: true, audio: false}, success, error);
			else
			if(n.mediaDevices.getUserMedia)
				n.mediaDevices.getUserMedia({video: { facingMode: "environment"} , audio: false})
					.then(success)
					.catch(error);
			else
			if(n.webkitGetUserMedia)
			{
				webkit=true;
				n.webkitGetUserMedia({video:true, audio: false}, success, error);
			}
			else
			if(n.mozGetUserMedia)
			{
				moz=true;
				n.mozGetUserMedia({video: true, audio: false}, success, error);
			}

			stype=1;
			setTimeout(captureToCanvas, 50);
		}
		
		function setimg()
		{
			document.getElementById("result").innerHTML="";
			if(stype==2)
				return;
			document.getElementById("outdiv").innerHTML = imghtml;
			document.getElementById("qrimg").style.opacity=1.0;
			document.getElementById("webcamimg").style.opacity=0.2;
			var qrfile = document.getElementById("qrfile");
			qrfile.addEventListener("dragenter", dragenter, false);  
			qrfile.addEventListener("dragover", dragover, false);  
			qrfile.addEventListener("drop", drop, false);
			stype=2;
		}
		
		function btnEntradaOnClick(element) {
			var nr_inscricao = element.dataset.nrmatricula;
			alert('Entrada da inscrição ' + nr_inscricao + ' registrada com sucesso!');
		}
		
		function btnSaidaOnClick(element) {
			var nr_inscricao = element.dataset.nrmatricula;
			alert('Saída da inscrição' + nrInscricao + ' registrada com sucesso!');
		}

		</script>
    </body>
</html>